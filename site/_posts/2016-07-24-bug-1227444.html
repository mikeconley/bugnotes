---
layout: post
title:  "Bug 1227444 - &quot;Restore Previous Session&quot; opens duplicate window"
date:   2016-07-24
tags:
---

<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1227444">
 Bug 1227444 - "Restore Previous Session" opens duplicate window
</a>
<div>
 Looks like a regression from the CPOW window work I did. Damn it.
 <span style="-evernote-sentoj-emoticon:true">
  ğŸ˜”
 </span>
</div>
<div>
 <br/>
</div>
<div>
 Okay, whatâ€™d I do wrong?
</div>
<div>
 <br/>
</div>
<div>
 Aliceâ€™s STR:
</div>
<div>
 <br/>
</div>
<div>
 StepsÂ toÂ reproduce
 <br/>
 1.Â StartÂ withÂ newlyÂ createdÂ profile
 <br/>
 ---Â Now,Â thereÂ isÂ singleÂ windowÂ withÂ 2Â tabs(
 <a href="https://www.mozilla.org/en-US/firefox/nightly/firstrun/">
  https://www.mozilla.org/en-US/firefox/nightly/firstrun/
 </a>
 andÂ about:home)
 <br/>
 2.Â CloseÂ browser
 <br/>
 3.Â StartÂ browserÂ withÂ theÂ profile
 <br/>
 4.Â PerformÂ "RestoreÂ PreviousÂ Session"
 <br/>
 <br/>
 ActualÂ results:
 <br/>
 "RestoreÂ PreviousÂ Session"Â opensÂ duplicateÂ window.
 <br/>
 Now,Â thereÂ isÂ 2Â windowsÂ withÂ 2Â tabs(
 <a href="https://www.mozilla.org/en-US/firefox/nightly/firstrun/">
  https://www.mozilla.org/en-US/firefox/nightly/firstrun/
 </a>
 andÂ about:home)
 <br/>
 <br/>
 ExpectedÂ results:
</div>
<div>
 "RestoreÂ PreviousÂ Session"Â shouldÂ openÂ onlyÂ previousÂ window.
</div>
<div>
 <br/>
</div>
<div>
 I was able to reproduce this on olâ€™ slowy mc-laptop.
</div>
<div>
 <br/>
</div>
<div>
 So hereâ€™s what I think is happening.
</div>
<div>
 <br/>
</div>
<ol>
 <li>
  Browsers havenâ€™t flushed yet
 </li>
 <li>
  We ask for quit, which causes a sync flush of all windows
 </li>
 <li>
  Finish prompting, and confirm that weâ€™re going down
 </li>
 <li>
  Window closes, which starts async flush
 </li>
 <li>
  Process starts to exit
 </li>
</ol>
<div>
 <br/>
</div>
<div>
 ...
</div>
<div>
 <br/>
</div>
<div>
 Okay, I see whatâ€™s really going on.
</div>
<div>
 <br/>
</div>
<div>
 Quit application is requested, and we do our TabState flush and save state with our two tabs for the window.
</div>
<div>
 We then close the windows, and start an async window flush, which will put the window in both the _closedWindows set, and in the _windows set, since we donâ€™t remove it from _windows until the flush is complete.
</div>
<div>
 We do a final write to the disk in that state, with the same window in _windows and _closedWindow.
</div>
<div>
 By the time the TabStateFlusher flushWindow Promise resolves, weâ€™ve already done our final write to the disk, and the party is over.
</div>
<div>
 <br/>
</div>
<div>
 I think we can safely remove the window from this._windows in the onClose method, and not within the Promise resolution.
</div>
<div>
 <br/>
</div>
<div>
 Patch seems to work! Posted for review.
</div>
<div>
 <br/>
</div>
<div>
 Bah, backed out because I actually broke some stuff. Luckily we had a test catch it. I need to make sure that we calculate whether or not the window is the â€œlast to closeâ€ before the window actually closes.
</div>
<div>
 <br/>
</div>
<div>
 Try:
 <a href="https://treeherder.mozilla.org/#/jobs?repo=try&amp;revision=e02c0cd0bf74">
 </a>
 <a href="https://treeherder.mozilla.org/#/jobs?repo=try&amp;revision=e02c0cd0bf74">
  https://treeherder.mozilla.org/#/jobs?repo=try&amp;revision=e02c0cd0bf74
 </a>
</div>
<div>
 <br/>
</div>
<div>
 Going to try to hack the tests from bug 1226333 into here so that we can get some coverage and this doesnâ€™t happen again.
</div>
<div>
 <br/>
</div>
<div>
 Those tests
</div>
<div>
 <br/>
</div>
<div>
 182 INFO TEST-UNEXPECTED-FAIL | browser/components/sessionstore/test/browser_async_window_flushing.js | We should have added the window to the closed windows array - Got 1, expected 2
</div>
<div>
 <br/>
</div>
<div>
 Try push with tests:
 <a href="https://treeherder.mozilla.org/#/jobs?repo=try&amp;revision=e865770694b2">
 </a>
 <a href="https://treeherder.mozilla.org/#/jobs?repo=try&amp;revision=e865770694b2">
  https://treeherder.mozilla.org/#/jobs?repo=try&amp;revision=e865770694b2
 </a>
</div>
<div>
 <br/>
</div>
<div>
 <br/>
</div>
